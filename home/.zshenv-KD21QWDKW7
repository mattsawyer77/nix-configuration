#!/usr/bin/env zsh

nix-config-check() {
  sudo caffeinate -i darwin-rebuild check --flake ~/workspaces/nix-configuration
  notify "nix config check"
}

nix-config-switch() {
  sudo caffeinate -i darwin-rebuild switch --flake ~/workspaces/nix-configuration
  notify "nix config switch"
}

nix-config-update() {
  (cd ~/workspaces/nix-configuration &&
    if [[ -n "$(git status --porcelain flake.lock)" ]]; then
      echo "flake.lock is dirty, please commit or revert before updating the flake"
      false
    fi &&
    nix flake update)
}

notify() {
  exit_code=$?
  current_cl=${history[$HISTCMD]}
  if [[ -v 1 ]]; then
    title="with title \"$1\""
  else
    last_cmd=$(echo "$current_cl" | sed 's/;[^;]*$//' | sed 's/"//g')
    title="with title \"$last_cmd\""
  fi
  if [[ $exit_code -eq 0 ]]; then
    osascript -e "display notification \"command succeeded\" $title sound name \"Funk\""
  else
    osascript -e "display notification \"command failed\" $title sound name \"Sosumi\""
  fi
  return $exit_code
}

# filtering out namespaces with `--` and jobs
jq_pod_resource_query='.items|map(select(.metadata.namespace|test(".*--.*")|not))|map(select(.metadata.ownerReferences[0].kind!="Job"))|map(.status.hostIP as $hostIP|.metadata.namespace as $ns|.metadata.name as $name|.spec.containers|map({namespace: $ns, pod: $name, container: .name, hostIP: $hostIP, cpu_requests: .resources.requests.cpu, cpu_limits: .resources.limits.cpu, gomaxprocs: ((.env//[])|map(select(.name=="GOMAXPROCS"))[0]|.value//.valueFrom.resourceFieldRef.resource)}))|flatten'
